<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>تتبع أي جسم على أي موقع</title>
<style>
  body, html { margin:0; padding:0; font-family:sans-serif; overflow:hidden; background:#000; }
  #controls {
    position:fixed; top:10px; left:10px; z-index:9999; background:rgba(0,0,0,0.7);
    color:white; padding:10px; border-radius:5px;
  }
  select, input, button { margin:5px; padding:5px; }
  #overlayCircle {
    position:absolute; width:60px; height:60px;
    border-radius:50%; border:3px solid red;
    pointer-events:none; z-index:10000; transition:all 0.05s linear;
  }
</style>
</head>
<body>

<div id="controls">
  <label>اختر الجسم للتتبع:</label>
  <select id="targetSelect">
    <option value="cup">كوب</option>
    <option value="person">وجه</option>
    <option value="doll">دمية</option>
    <option value="sports ball">كرة</option>
    <option value="car">سيارة</option>
    <option value="cat">حيوان</option>
  </select>
  <input type="color" id="circleColor" value="#ff0000">
  <label>حجم الدائرة:</label>
  <input type="range" id="circleSize" min="40" max="120" value="60">
  <button id="startTrack">ابدأ التتبع</button>
</div>

<div id="overlayCircle"></div>

<iframe id="siteFrame" src="https://www.youtube.com" style="width:100%;height:100vh;border:none;"></iframe>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.2.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>

<script>
const overlay = document.getElementById('overlayCircle');
const targetSelect = document.getElementById('targetSelect');
const circleColor = document.getElementById('circleColor');
const circleSize = document.getElementById('circleSize');
const startBtn = document.getElementById('startTrack');
const iframe = document.getElementById('siteFrame');

let model = null;
let targetClass = targetSelect.value;
let tracking = false;

// تحديث خصائص الدائرة
circleColor.addEventListener('input',()=>overlay.style.borderColor=circleColor.value);
circleSize.addEventListener('input',()=>{overlay.style.width=circleSize.value+'px'; overlay.style.height=circleSize.value+'px';});
targetSelect.addEventListener('change',()=>targetClass=targetSelect.value);

async function initModel(){
  model = await cocoSsd.load();
}

async function trackScreen(){
  if(!tracking) return;

  // Capture الشاشة
  try{
    const stream = await navigator.mediaDevices.getDisplayMedia({video:true});
    const video = document.createElement('video');
    video.srcObject = stream;
    await video.play();

    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    async function detectLoop(){
      if(!tracking) { stream.getTracks().forEach(t=>t.stop()); return; }

      ctx.drawImage(video,0,0,canvas.width,canvas.height);
      const predictions = await model.detect(canvas);
      let targetBox = null;

      for(let p of predictions){
        if(p.class===targetClass){
          targetBox=p.bbox; break;
        }
      }

      if(targetBox){
        const [x,y,w,h]=targetBox;
        const scaleX = window.innerWidth/canvas.width;
        const scaleY = window.innerHeight/canvas.height;

        overlay.style.left=(x+w/2-overlay.offsetWidth/2)*scaleX+'px';
        overlay.style.top=(y+h/2-overlay.offsetHeight/2)*scaleY+'px';
      }

      requestAnimationFrame(detectLoop);
    }

    detectLoop();

  }catch(err){ console.error("خطأ في الوصول للشاشة:",err); }
}

// بدء التتبع تلقائي
startBtn.addEventListener('click', ()=>{
  tracking = true;
  if(!model) initModel().then(trackScreen);
  else trackScreen();
});
</script>

</body>
</html>
