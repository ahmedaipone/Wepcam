<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>تتبع الأجسام قوي بدون OpenCV</title>
<style>
  body, html { margin:0; padding:0; background:#000; overflow:hidden; font-family:sans-serif; color:white; }
  #video { position:absolute; width:100%; height:auto; }
  #overlayCircle {
    position:absolute;
    width:60px;
    height:60px;
    border-radius:50%;
    border:3px solid red;
    pointer-events:auto;
    z-index:9999;
    cursor:grab;
    transition: all 0.03s linear;
  }
  #controls { position:fixed; top:10px; left:10px; z-index:10000; background:rgba(0,0,0,0.6); padding:10px; border-radius:5px; }
  input { padding:5px; margin:5px; }
</style>
</head>
<body>

<div id="controls">
  <input type="file" id="videoFile" accept="video/*"><br>
  <label>لون الدائرة:</label>
  <input type="color" id="circleColor" value="#ff0000"><br>
  <label>حجم الدائرة:</label>
  <input type="range" id="circleSize" min="30" max="120" value="60"><br>
</div>

<video id="video" playsinline></video>
<div id="overlayCircle"></div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.2.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>

<script>
let video = document.getElementById('video');
let circle = document.getElementById('overlayCircle');
let startTracking = false;
let model = null;

// اللون والحجم
document.getElementById('circleColor').addEventListener('input', e => circle.style.borderColor = e.target.value);
document.getElementById('circleSize').addEventListener('input', e => {
  let size = parseInt(e.target.value);
  circle.style.width = size + 'px';
  circle.style.height = size + 'px';
});

// رفع الفيديو
document.getElementById('videoFile').addEventListener('change', async (e)=>{
  const file = e.target.files[0];
  if(file){
    video.src = URL.createObjectURL(file);
    await video.play();
    if(!model) model = await cocoSsd.load();
    startTracking = true;
    trackLoop();
  }
});

// السحب باللمس
let dragging = false;
circle.addEventListener('mousedown', ()=>dragging=true);
circle.addEventListener('mouseup', ()=>dragging=false);
circle.addEventListener('mouseleave', ()=>dragging=false);
circle.addEventListener('mousemove', e=>{
  if(dragging && !startTracking){
    circle.style.left = e.pageX - circle.offsetWidth/2 + 'px';
    circle.style.top  = e.pageY - circle.offsetHeight/2 + 'px';
  }
});
circle.addEventListener('touchstart', e => { dragging = true; });
circle.addEventListener('touchend', e => { dragging = false; });
circle.addEventListener('touchcancel', e => { dragging = false; });
circle.addEventListener('touchmove', e => {
  if(dragging && !startTracking){
    const touch = e.touches[0];
    circle.style.left = touch.pageX - circle.offsetWidth/2 + 'px';
    circle.style.top  = touch.pageY - circle.offsetHeight/2 + 'px';
  }
});

// حلقة التتبع باستخدام TensorFlow.js
async function trackLoop(){
  if(video.paused || video.ended || !startTracking){
    requestAnimationFrame(trackLoop);
    return;
  }
  
  const predictions = await model.detect(video);
  if(predictions.length > 0){
    // إيجاد أقرب جسم للدائرة الحالية
    let cx = circle.offsetLeft + circle.offsetWidth/2;
    let cy = circle.offsetTop + circle.offsetHeight/2;
    let bestDist = Infinity;
    let bestBox = null;
    for(let p of predictions){
      const [x,y,w,h] = p.bbox;
      const px = x + w/2;
      const py = y + h/2;
      const dist = Math.hypot(cx-px, cy-py);
      if(dist < bestDist){
        bestDist = dist;
        bestBox = p.bbox;
      }
    }
    if(bestBox){
      const [x,y,w,h] = bestBox;
      circle.style.left = x + w/2 - circle.offsetWidth/2 + 'px';
      circle.style.top  = y + h/2 - circle.offsetHeight/2 + 'px';
    }
  }
  
  requestAnimationFrame(trackLoop);
}
</script>

</body>
</html>    if(dist < minDist){
      minDist = dist;
      bestBox = p.bbox;
    }
  }
  
  if(bestBox){
    const [bx,by,bw,bh] = bestBox;
    let src = new cv.Mat(video.videoHeight, video.videoWidth, cv.CV_8UC4);
    videoCap.read(src);
    tracker = new cv.TrackerCSRT();
    let rect = new cv.Rect(bx, by, bw, bh);
    tracker.init(src, rect);
    src.delete();
  }

  trackLoop();
});

// حلقة التتبع
function trackLoop(){
  if(video.paused || video.ended){
    requestAnimationFrame(trackLoop);
    return;
  }
  
  if(tracker){
    let src = new cv.Mat(video.videoHeight, video.videoWidth, cv.CV_8UC4);
    videoCap.read(src);
    let rect = new cv.Rect();
    let ok = tracker.update(src, rect);
    if(ok){
      circle.style.left = rect.x + rect.width/2 - circle.offsetWidth/2 + 'px';
      circle.style.top  = rect.y + rect.height/2 - circle.offsetHeight/2 + 'px';
    }
    src.delete();
  }
  
  requestAnimationFrame(trackLoop);
}
</script>

</body>
</html>
