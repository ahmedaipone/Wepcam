<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>تتبع الأجسام التلقائي</title>
<style>
  body, html { margin:0; padding:0; background:#000; overflow:hidden; font-family:sans-serif; color:white; }
  #video { position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover; }
  #overlayCircle {
    position:absolute;
    width:60px;  /* حجم أصغر */
    height:60px;
    border-radius:50%;
    border:3px solid red;
    pointer-events:none;
    z-index:9999;
    transition: all 0.03s linear; /* حركة سلسة */
  }
  #info {
    position:fixed; top:10px; right:10px; background:rgba(0,0,0,0.6); padding:5px 10px; border-radius:5px;
  }
  #controls {
    position:fixed; top:10px; left:10px; z-index:10000; background:rgba(0,0,0,0.6); padding:10px; border-radius:5px;
  }
  select, input { padding:5px; margin:5px; }
</style>
</head>
<body>

<div id="controls">
  <input type="file" id="videoFile" accept="video/*"><br>
  <label>اختر الجسم للتتبع: </label>
  <select id="targetSelect">
    <option value="cup">كوب</option>
    <option value="person">وجه</option>
    <option value="doll">دمية</option>
    <option value="sports ball">كرة</option>
    <option value="car">سيارة</option>
    <option value="cat">حيوان</option>
  </select><br>
  <label>لون الدائرة:</label>
  <input type="color" id="circleColor" value="#ff0000"><br>
  <label>حجم الدائرة:</label>
  <input type="range" id="circleSize" min="50" max="200" value="60">
</div>

<video id="video" playsinline autoplay muted></video>
<div id="overlayCircle"></div>
<div id="info">جارٍ التحميل...</div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.2.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
<script async src="https://docs.opencv.org/4.x/opencv.js" type="text/javascript"></script>

<script>
let video = document.getElementById('video');
let circle = document.getElementById('overlayCircle');
let info = document.getElementById('info');
let targetClass = 'cup';
let tracker = null;
let model = null;
let videoCap = null;

document.getElementById('targetSelect').addEventListener('change', e => { targetClass = e.target.value; });
document.getElementById('circleColor').addEventListener('input', e => { circle.style.borderColor = e.target.value; });
document.getElementById('circleSize').addEventListener('input', e => {
  let size = parseInt(e.target.value);
  circle.style.width = size + 'px';
  circle.style.height = size + 'px';
});

// اختيار فيديو جاهز
document.getElementById('videoFile').addEventListener('change', async e => {
  const file = e.target.files[0];
  if(file){
    video.src = URL.createObjectURL(file);
    await video.play();
    videoCap = new cv.VideoCapture(video);
  }
});

// دالة بدء الكاميرا التلقائية إذا لم يتم اختيار فيديو
async function startCamera() {
  if(video.srcObject) return;
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
    video.srcObject = stream;
    return new Promise(resolve => video.onloadedmetadata = resolve);
  } catch(e){
    info.innerText = "فشل الوصول إلى الكاميرا";
  }
}

async function init() {
  await startCamera();
  info.innerText = "جارٍ تحميل النموذج...";
  model = await cocoSsd.load();
  info.innerText = "تم التحميل، يبدأ التتبع تلقائياً";
  detectAndTrack();
}

async function detectAndTrack(){
  if(video.paused || video.ended) {
    requestAnimationFrame(detectAndTrack);
    return;
  }

  const predictions = await model.detect(video);
  let targetBox = null;

  for(let p of predictions){
    if(p.class === targetClass){
      targetBox = p.bbox; // [x,y,w,h]
      break;
    }
  }

  if(targetBox && !tracker){
    let [x,y,w,h] = targetBox;
    if(videoCap){
      let src = new cv.Mat(video.videoHeight, video.videoWidth, cv.CV_8UC4);
      videoCap.read(src);
      tracker = new cv.TrackerCSRT();
      tracker.init(src, new cv.Rect(x,y,w,h));
      src.delete();
    }
  }

  if(tracker){
    let src = new cv.Mat(video.videoHeight, video.videoWidth, cv.CV_8UC4);
    videoCap.read(src);
    let rect = new cv.Rect();
    let ok = tracker.update(src, rect);
    if(ok){
      circle.style.left = rect.x + rect.width/2 - circle.offsetWidth/2 + 'px';
      circle.style.top  = rect.y + rect.height/2 - circle.offsetHeight/2 + 'px';
      info.innerText = `X:${Math.round(rect.x)}, Y:${Math.round(rect.y)}, W:${Math.round(rect.width)}, H:${Math.round(rect.height)}`;
    } else {
      info.innerText = 'فقد الهدف، يعاد التتبع تلقائياً...';
      tracker = null;
    }
    src.delete();
  }

  requestAnimationFrame(detectAndTrack);
}

init();
</script>

</body>
</html>    let src = new cv.Mat(video.videoHeight, video.videoWidth, cv.CV_8UC4);
    videoCap.read(src);
    tracker = new cv.TrackerCSRT();
    let rect = new cv.Rect(x,y,w,h);
    tracker.init(src, rect);
    src.delete();
  }

  // تحديث التتبع
  if(tracker){
    let src = new cv.Mat(video.videoHeight, video.videoWidth, cv.CV_8UC4);
    videoCap.read(src);
    let rect = new cv.Rect();
    let ok = tracker.update(src, rect);
    if(ok){
      circle.style.left = rect.x + rect.width/2 - circle.offsetWidth/2 + 'px';
      circle.style.top  = rect.y + rect.height/2 - circle.offsetHeight/2 + 'px';
      info.innerHTML = `X: ${Math.round(rect.x)}, Y: ${Math.round(rect.y)}, W: ${Math.round(rect.width)}, H: ${Math.round(rect.height)}`;
    } else {
      info.innerHTML = 'فقد الهدف، اضغط إعادة تعيين';
      tracker = null;
    }
    src.delete();
  }

  requestAnimationFrame(detectAndTrack);
}
</script>

</body>
</html>
